import React, { useEffect, useMemo, useRef, useState } from "react";
import SignatureCanvas from "react-signature-canvas";
import * as pdfjsLib from "pdfjs-dist";
import pdfWorker from "pdfjs-dist/build/pdf.worker.min?url";

// ✅ Vite-safe worker setup
pdfjsLib.GlobalWorkerOptions.workerSrc = pdfWorker;

const STEPS = [
  { key: "upload", label: "1) Upload" },
  { key: "business", label: "2) Business" },
  { key: "principal", label: "3) Principal + Banking" },
  { key: "additional", label: "4) Additional + Sign" }
] as const;

type StepKey = typeof STEPS[number]["key"];

interface FormData {
  legalBusinessName: string;
  dbaName: string;
  businessEstablishedDate: string;
  taxpayerId: string;
  businessPhone: string;
  businessType: string;
  businessTypeOther: string;
  physicalStreet: string;
  physicalUnit: string;
  physicalCity: string;
  physicalState: string;
  physicalZip: string;
  businessSameAsPhysical: boolean;
  businessStreet: string;
  businessUnit: string;
  businessCity: string;
  businessState: string;
  businessZip: string;
  businessEmail: string;
  businessWebsite: string;
  fnsNumber: string;
  ownerLastName: string;
  ownerFirstName: string;
  ownerMiddleName: string;
  ownerTitle: string;
  ownerOwnershipPct: string;
  dob: string;
  ownerSsn: string;
  ownerHomePhone: string;
  principalAddressStreet: string;
  principalAddressUnit: string;
  principalAddressCity: string;
  principalAddressState: string;
  principalAddressZip: string;
  idNumber: string;
  dlState: string;
  idExp: string;
  contactEmail: string;
  contactPhone: string;
  bankName: string;
  bankAddress: string;
  bankContactName: string;
  bankContactPhone: string;
  accountNumber: string;
  routingNumber: string;
  ccTerminal: string;
  encryption: string;
  gasStationPos: string;
  installationDate: string;
  pricing: string;
  otherfleetcards: string;
  otherNotes: string;
  signatureName: string;
  signatureDate: string;
  signatureImageDataUrl: string;
  termsAccepted: boolean;
}

const emptyForm: FormData = {
  legalBusinessName: "",
  dbaName: "",
  businessEstablishedDate: "",
  taxpayerId: "",
  businessPhone: "",
  businessType: "",
  businessTypeOther: "",
  physicalStreet: "",
  physicalUnit: "",
  physicalCity: "",
  physicalState: "",
  physicalZip: "",
  businessSameAsPhysical: false,
  businessStreet: "",
  businessUnit: "",
  businessCity: "",
  businessState: "",
  businessZip: "",
  businessEmail: "",
  businessWebsite: "",
  fnsNumber: "",
  ownerLastName: "",
  ownerFirstName: "",
  ownerMiddleName: "",
  ownerTitle: "",
  ownerOwnershipPct: "",
  dob: "",
  ownerSsn: "",
  ownerHomePhone: "",
  principalAddressStreet: "",
  principalAddressUnit: "",
  principalAddressCity: "",
  principalAddressState: "",
  principalAddressZip: "",
  idNumber: "",
  dlState: "",
  idExp: "",
  contactEmail: "",
  contactPhone: "",
  bankName: "",
  bankAddress: "",
  bankContactName: "",
  bankContactPhone: "",
  accountNumber: "",
  routingNumber: "",
  ccTerminal: "",
  encryption: "",
  gasStationPos: "",
  installationDate: "",
  pricing: "",
  otherfleetcards: "",
  otherNotes: "",
  signatureName: "",
  signatureDate: "",
  signatureImageDataUrl: "",
  termsAccepted: false
};

function normalizeISODate(s: string | null | undefined): string {
  if (!s) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = String(s).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if (!m) return "";
  return `${m[3]}-${String(m[1]).padStart(2, "0")}-${String(m[2]).padStart(2, "0")}`;
}

function digitsOnly(s: string | number | null | undefined): string {
  return String(s || "").replace(/\D/g, "");
}

function validLenDigits(s: string | number | null | undefined, len: number): boolean {
  const d = digitsOnly(s);
  return d.length === len;
}

async function fileToImageDataUrl(file: File | null): Promise<string | null> {
  if (!file) return null;

  if (file.type.startsWith("image/")) {
    return await new Promise<string>((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result as string);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  if (file.type === "application/pdf") {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 1.6 });

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    if (!ctx) return null;
    
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    // await page.render({ canvasContext: ctx, viewport }).promise;
    // ✅ NEW (correct API)
    await page.render({ canvas, viewport }).promise;

    return canvas.toDataURL("image/png");
  }

  return null;
}

async function fileToDataUrlRaw(file: File | null): Promise<string | null> {
  if (!file) return null;
  return await new Promise<string>((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result as string);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function resizeSigCanvas(sigRef: React.RefObject<SignatureCanvas | null>): void {
  const sig = sigRef && sigRef.current;
  if (!sig) return;

  const canvas = sig.getCanvas();
  if (!canvas) return;

  const ratio = Math.max(window.devicePixelRatio || 1, 1);

  const parent = canvas.parentElement;
  if (!parent) return;

  const rect = parent.getBoundingClientRect();
  const width = Math.max(1, rect.width);
  const height = 220;

  sig.clear();

  canvas.style.width = width + "px";
  canvas.style.height = height + "px";

  canvas.width = Math.floor(width * ratio);
  canvas.height = Math.floor(height * ratio);

  const ctx = canvas.getContext("2d");
  if (ctx) ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
}

export default function MerchantForm() {
  const [stepIndex, setStepIndex] = useState<number>(0);
  const step = STEPS[stepIndex].key;

  const [form, setForm] = useState<FormData>(emptyForm);

  const [idFile, setIdFile] = useState<File | null>(null);
  const [checkFile, setCheckFile] = useState<File | null>(null);
  const [w9File, setW9File] = useState<File | null>(null);

  const [consent, setConsent] = useState<boolean>(false);
  const [busy, setBusy] = useState<boolean>(false);
  const [status, setStatus] = useState<string>("");

  const [showEIN, setShowEIN] = useState<boolean>(true);
  const [showSSN, setShowSSN] = useState<boolean>(true);

  const sigRef = useRef<SignatureCanvas | null>(null);

  useEffect(() => {
    const t = setTimeout(() => resizeSigCanvas(sigRef), 0);

    const onResize = () => resizeSigCanvas(sigRef);
    window.addEventListener("resize", onResize);

    return () => {
      clearTimeout(t);
      window.removeEventListener("resize", onResize);
    };
  }, []);

  useEffect(() => {
    if (step === "additional") {
      const t = setTimeout(() => resizeSigCanvas(sigRef), 0);
      return () => clearTimeout(t);
    }
  }, [step]);

  const hasAllDocs = useMemo(() => !!(idFile && checkFile && w9File), [idFile, checkFile, w9File]);

  function setVal<K extends keyof FormData>(k: K, v: FormData[K]): void {
    setForm((p) => ({ ...p, [k]: v }));
  }

  function syncBizAddress(checked: boolean): void {
    setVal("businessSameAsPhysical", checked);
    if (checked) {
      setForm((p) => ({
        ...p,
        businessStreet: p.physicalStreet,
        businessUnit: p.physicalUnit,
        businessCity: p.physicalCity,
        businessState: p.physicalState,
        businessZip: p.physicalZip
      }));
    }
  }

  async function handlePrefill() {
    if (!idFile || !checkFile || !w9File) {
      alert("All 3 documents are required (Photo ID + Check/Letter + W-9).");
      return;
    }

    if (!consent) {
      alert("Consent is not checked. OCR prefill is disabled. Please continue and fill manually.");
      return;
    }

    try {
      setBusy(true);
      setStatus("Scanning documents…");

      const [idImg, checkImg, w9Img] = await Promise.all([
        fileToImageDataUrl(idFile),
        fileToImageDataUrl(checkFile),
        fileToImageDataUrl(w9File)
      ]);

      if ((idFile && !idImg) || (checkFile && !checkImg) || (w9File && !w9Img)) {
        throw new Error("Could not convert one of the uploaded PDFs/images for OCR. Try re-uploading as an image.");
      }

      const resp = await fetch("/api/extract", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          consent,
          idImageDataUrl: idImg,
          checkImageDataUrl: checkImg,
          w9ImageDataUrl: w9Img
        })
      });

      const json = await resp.json();
      if (!resp.ok || !json.success) throw new Error(json.error || "Extract failed");

      const { id_fields, bank_fields, w9_fields } = json.extracted || {};

      setForm((p) => {
        const next = { ...p };

        if (id_fields) {
          next.ownerFirstName = id_fields.first_name || next.ownerFirstName;
          next.ownerMiddleName = id_fields.middle_name || next.ownerMiddleName;
          next.ownerLastName = id_fields.last_name || next.ownerLastName;
          next.dob = normalizeISODate(id_fields.dob) || next.dob;
          next.idNumber = id_fields.id_number || next.idNumber;
          next.idExp = normalizeISODate(id_fields.id_expiration) || next.idExp;

          next.principalAddressStreet = id_fields.address_line || next.principalAddressStreet;
          next.principalAddressCity = id_fields.city || next.principalAddressCity;
          next.principalAddressState = id_fields.state || next.principalAddressState;
          next.principalAddressZip = id_fields.postal_code || next.principalAddressZip;
          next.dlState = id_fields.state || next.dlState;
        }

        if (bank_fields) {
          next.bankName = bank_fields.bank_name || next.bankName;
          next.routingNumber = bank_fields.routing_number || next.routingNumber;
          next.accountNumber = bank_fields.account_number || next.accountNumber;
        }

        if (w9_fields) {
          next.legalBusinessName = w9_fields.business_name || w9_fields.name || next.legalBusinessName;
          next.physicalStreet = w9_fields.address_line || next.physicalStreet;
          next.physicalCity = w9_fields.city || next.physicalCity;
          next.physicalState = w9_fields.state || next.physicalState;
          next.physicalZip = w9_fields.postal_code || next.physicalZip;
        }

        if (next.businessSameAsPhysical) {
          next.businessStreet = next.physicalStreet;
          next.businessUnit = next.physicalUnit;
          next.businessCity = next.physicalCity;
          next.businessState = next.physicalState;
          next.businessZip = next.physicalZip;
        }

        return next;
      });

      setStatus("✅ Prefill complete. Continue to complete the application.");
    } catch (e) {
      console.error(e);
      setStatus("❌ Prefill failed.");
      alert((e as Error).message || "Prefill failed");
    } finally {
      setBusy(false);
    }
  }

  function validateStepOrAlert(): boolean {
    if (step === "business") {
      const required: (keyof FormData)[] = [
        "legalBusinessName",
        "dbaName",
        "businessEstablishedDate",
        "taxpayerId",
        "businessPhone",
        "businessType",
        "physicalStreet",
        "physicalCity",
        "physicalState",
        "physicalZip",
        "businessEmail"
      ];
      for (const k of required) {
        if (!String(form[k] || "").trim()) {
          alert(`Missing required: ${k}`);
          return false;
        }
      }
      if (!validLenDigits(form.taxpayerId, 9)) {
        alert("EIN must be 9 digits.");
        return false;
      }
      return true;
    }

    if (step === "principal") {
      const required: (keyof FormData)[] = [
        "ownerFirstName",
        "ownerLastName",
        "ownerTitle",
        "ownerOwnershipPct",
        "dob",
        "ownerSsn",
        "principalAddressStreet",
        "principalAddressCity",
        "principalAddressState",
        "principalAddressZip",
        "idNumber",
        "dlState",
        "idExp",
        "contactEmail",
        "contactPhone",
        "bankName",
        "routingNumber",
        "accountNumber"
      ];
      for (const k of required) {
        if (!String(form[k] || "").trim()) {
          alert(`Missing required: ${k}`);
          return false;
        }
      }
      if (!validLenDigits(form.ownerSsn, 9)) {
        alert("SSN must be 9 digits.");
        return false;
      }
      if (form.contactPhone && !validLenDigits(form.contactPhone, 10)) {
        alert("Cell phone must be 10 digits.");
        return false;
      }
      if (form.ownerHomePhone && !validLenDigits(form.ownerHomePhone, 10)) {
        alert("Home phone must be 10 digits.");
        return false;
      }
      return true;
    }

    if (step === "additional") {
      if (!String(form.signatureName || "").trim()) {
        alert("Signature name is required.");
        return false;
      }
      if (!String(form.signatureDate || "").trim()) {
        alert("Signature date is required.");
        return false;
      }
      if (!form.termsAccepted) {
        alert("You must accept Terms & Conditions.");
        return false;
      }

      if (!sigRef.current || sigRef.current.isEmpty()) {
        alert("Please sign in the signature box.");
        return false;
      }
      return true;
    }

    return true;
  }

  async function handleSubmit() {
    try {
      if (!validateStepOrAlert()) return;

      setBusy(true);
      setStatus("Submitting…");

      const signatureDataUrl = sigRef.current!.toDataURL("image/png");
      const finalForm = {
        ...form,
        signatureImageDataUrl: signatureDataUrl,
        termsAccepted: !!form.termsAccepted
      };

      const [idRaw, checkRaw, w9Raw] = await Promise.all([
        fileToDataUrlRaw(idFile),
        fileToDataUrlRaw(checkFile),
        fileToDataUrlRaw(w9File)
      ]);

      const fileAttachments: Record<string, { filename: string; mimeType: string; dataUrl: string }> = {};
      if (idFile && idRaw) fileAttachments.idFile = { filename: idFile.name, mimeType: idFile.type, dataUrl: idRaw };
      if (checkFile && checkRaw) fileAttachments.checkFile = { filename: checkFile.name, mimeType: checkFile.type, dataUrl: checkRaw };
      if (w9File && w9Raw) fileAttachments.w9File = { filename: w9File.name, mimeType: w9File.type, dataUrl: w9Raw };

      const resp = await fetch("/api/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ formData: finalForm, fileAttachments })
      });

      const json = await resp.json();
      if (!resp.ok || !json.success) throw new Error(json.error || "Submit failed");

      window.location.href = `/success?appId=${encodeURIComponent(json.appId)}`;

      setStatus(`✅ Submitted. App ID: ${json.appId}`);
    } catch (e) {
      console.error(e);
      alert((e as Error).message || "Submit failed");
      setStatus("❌ Submit failed.");
    } finally {
      setBusy(false);
    }
  }

  function next() {
    if (step !== "upload" && !validateStepOrAlert()) return;
    setStepIndex((i) => Math.min(i + 1, STEPS.length - 1));
  }

  function back() {
    setStepIndex((i) => Math.max(i - 1, 0));
  }

  return (
    <div className="container">
      <div className="header">
        <div className="logo-wrap">
          <img src="/logo.svg" alt="Halo" />
        </div>
        <h1 className="h1">Merchant Application - V12.26</h1>
        <p className="sub">Upload documents, optionally prefill with OCR (with consent), then submit.</p>
      </div>

      <div className="stepper">
        {STEPS.map((s, idx) => (
          <div key={s.key} className={"pill " + (idx === stepIndex ? "pillActive" : "")}>
            {s.label}
          </div>
        ))}
      </div>

      

      {step === "upload" && (
        <div className="card">
          <div className="cardTitle">1) Upload Documents</div>

          <div className="grid2">
            <div className="row">
              <div className="label">Photo ID (image or PDF)</div>
              <input className="input" type="file" accept="image/*,.pdf" onChange={(e) => setIdFile(e.target.files?.[0] || null)} />
            </div>

            <div className="row">
              <div className="label">Voided Check or Bank letter (image or PDF)</div>
              <input className="input" type="file" accept="image/*,.pdf" onChange={(e) => setCheckFile(e.target.files?.[0] || null)} />
            </div>

            <div className="row">
              <div className="label">W-9 (image or PDF)</div>
              <input className="input" type="file" accept="image/*,.pdf" onChange={(e) => setW9File(e.target.files?.[0] || null)} />
              <div className="notice">
                Download blank W-9 from IRS:{" "}
                <a href="https://www.irs.gov/pub/irs-pdf/fw9.pdf" target="_blank" rel="noreferrer">
                  fw9.pdf
                </a>
              </div>
            </div>

            <div className="row">
              <label className="notice checkboxLine">
                <input type="checkbox" checked={consent} onChange={(e) => setConsent(e.target.checked)} /> I consent to OCR prefill from uploaded documents
              </label>
              <div className="notice subtle">Note: We do not OCR SSN/EIN from W-9.</div>
            </div>
          </div>

          <div className="btnRow">
            <button
              className="btn btnPrimary"
              disabled={busy || !hasAllDocs || !consent}
              onClick={handlePrefill}
            >
              {busy ? "Scanning…" : "Prefill Application"}
            </button>
            <button
              className="btn btnGhost"
              disabled={busy || !hasAllDocs}
              onClick={() => setStepIndex(1)}
            >
              Continue
            </button>
          </div>

          {!hasAllDocs && (
            <div className="notice" style={{ marginTop: 10 }}>
              Upload all 3 documents (Photo ID + Voided Check/Letter + W-9) to continue.
            </div>
          )}
          {hasAllDocs && !consent && (
            <div className="notice subtle" style={{ marginTop: 10 }}>
              Consent is optional. If unchecked, you can continue and fill manually (no OCR).
            </div>
          )}

          {!!status && <div className="notice" style={{ marginTop: 10 }}>{status}</div>}
        </div>
      )}

      {step === "business" && (
        <div className="card">
          <div className="cardTitle">2) Business Information</div>

          <div className="grid2">
            <div className="row">
              <div className="label">Legal Name of Business *</div>
              <input className="input" value={form.legalBusinessName} onChange={(e) => setVal("legalBusinessName", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">DBA Name *</div>
              <input className="input" value={form.dbaName} onChange={(e) => setVal("dbaName", e.target.value)} />
            </div>

            <div className="row">
              <div className="label">Date Established *</div>
              <input className="input" type="date" value={form.businessEstablishedDate} onChange={(e) => setVal("businessEstablishedDate", e.target.value)} />
            </div>

            <div className="row">
              <div className="label">Taxpayer ID (EIN) * (9 digits)</div>
              <div className="eyeWrap">
                <input
                  className="input eyeInput"
                  type={showEIN ? "text" : "password"}
                  inputMode="numeric"
                  value={form.taxpayerId}
                  onChange={(e) => setVal("taxpayerId", digitsOnly(e.target.value).slice(0, 9))}
                  placeholder="#########"
                />
                <button type="button" className="eyeBtn" onClick={() => setShowEIN((s) => !s)}>
                  {showEIN ? "Hide" : "Show"}
                </button>
              </div>
              <div className="notice subtle">Digits only. Validates 9 digits.</div>
            </div>

            <div className="row">
              <div className="label">Business Phone *</div>
              <input className="input" inputMode="numeric" value={form.businessPhone} onChange={(e) => setVal("businessPhone", digitsOnly(e.target.value).slice(0, 10))} />
              <div className="notice subtle">Digits only. (10 digits)</div>
            </div>

            <div className="row">
              <div className="label">Type of Business *</div>
              <select className="select" value={form.businessType} onChange={(e) => setVal("businessType", e.target.value)}>
                <option value="">Select…</option>
                <option value="restaurant">Restaurant</option>
                <option value="convenience">Convenience Store</option>
                <option value="liquor">Liquor Store</option>
                <option value="ecommerce">E-Commerce</option>
                <option value="service">Service</option>
                <option value="other">Other</option>
              </select>
            </div>

            {form.businessType === "other" && (
              <div className="row">
                <div className="label">If Other, Describe</div>
                <input className="input" value={form.businessTypeOther} onChange={(e) => setVal("businessTypeOther", e.target.value)} />
              </div>
            )}
          </div>

          <div className="sectionHeading">Physical Address</div>
          <div className="grid3">
            <div className="row">
              <div className="label">Street *</div>
              <input className="input" value={form.physicalStreet} onChange={(e) => setVal("physicalStreet", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Unit #</div>
              <input className="input" value={form.physicalUnit} onChange={(e) => setVal("physicalUnit", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">City *</div>
              <input className="input" value={form.physicalCity} onChange={(e) => setVal("physicalCity", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">State *</div>
              <input className="input" value={form.physicalState} onChange={(e) => setVal("physicalState", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">ZIP *</div>
              <input className="input" inputMode="numeric" value={form.physicalZip} onChange={(e) => setVal("physicalZip", digitsOnly(e.target.value).slice(0, 10))} />
            </div>
          </div>

          <div className="row">
            <label className="notice checkboxLine">
              <input type="checkbox" checked={form.businessSameAsPhysical} onChange={(e) => syncBizAddress(e.target.checked)} /> Business address same as physical
            </label>
          </div>

          <div className="sectionHeading">Business Address</div>
          <div className="grid3">
            <div className="row">
              <div className="label">Street *</div>
              <input className="input" value={form.businessStreet} onChange={(e) => setVal("businessStreet", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Unit #</div>
              <input className="input" value={form.businessUnit} onChange={(e) => setVal("businessUnit", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">City *</div>
              <input className="input" value={form.businessCity} onChange={(e) => setVal("businessCity", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">State *</div>
              <input className="input" value={form.businessState} onChange={(e) => setVal("businessState", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">ZIP *</div>
              <input className="input" inputMode="numeric" value={form.businessZip} onChange={(e) => setVal("businessZip", digitsOnly(e.target.value).slice(0, 10))} />
            </div>
          </div>

          <div className="grid2">
            <div className="row">
              <div className="label">Business Email *</div>
              <input className="input" value={form.businessEmail} onChange={(e) => setVal("businessEmail", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Website</div>
              <input className="input" value={form.businessWebsite} onChange={(e) => setVal("businessWebsite", e.target.value)} />
            </div>
          </div>

          <div className="btnRow">
            <button className="btn btnGhost" onClick={back}>Back</button>
            <button className="btn btnPrimary" onClick={next}>Next</button>
          </div>
        </div>
      )}

      {step === "principal" && (
        <div className="card">
          <div className="cardTitle">3) Principal + Banking</div>

          <div className="sectionHeading">Principal</div>
          <div className="grid2">
            <div className="row">
              <div className="label">First Name *</div>
              <input className="input" value={form.ownerFirstName} onChange={(e) => setVal("ownerFirstName", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Last Name *</div>
              <input className="input" value={form.ownerLastName} onChange={(e) => setVal("ownerLastName", e.target.value)} />
            </div>

            <div className="row">
              <div className="label">Owner Title *</div>
              <input className="input" value={form.ownerTitle} onChange={(e) => setVal("ownerTitle", e.target.value)} placeholder="Owner / President" />
            </div>

            <div className="row">
              <div className="label">Ownership % *</div>
              <input className="input" inputMode="numeric" value={form.ownerOwnershipPct} onChange={(e) => setVal("ownerOwnershipPct", digitsOnly(e.target.value).slice(0, 3))} />
            </div>

            <div className="row">
              <div className="label">DOB *</div>
              <input className="input" type="date" value={form.dob} onChange={(e) => setVal("dob", e.target.value)} />
            </div>

            <div className="row">
              <div className="label">SSN * (9 digits)</div>
              <div className="eyeWrap">
                <input
                  className="input eyeInput"
                  type={showSSN ? "text" : "password"}
                  inputMode="numeric"
                  value={form.ownerSsn}
                  onChange={(e) => setVal("ownerSsn", digitsOnly(e.target.value).slice(0, 9))}
                  placeholder="#########"
                />
                <button type="button" className="eyeBtn" onClick={() => setShowSSN((s) => !s)}>
                  {showSSN ? "Hide" : "Show"}
                </button>
              </div>
            </div>
          </div>

          <div className="sectionHeading">Principal Address</div>
          <div className="grid3">
            <div className="row">
              <div className="label">Street *</div>
              <input className="input" value={form.principalAddressStreet} onChange={(e) => setVal("principalAddressStreet", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Unit #</div>
              <input className="input" value={form.principalAddressUnit} onChange={(e) => setVal("principalAddressUnit", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">City *</div>
              <input className="input" value={form.principalAddressCity} onChange={(e) => setVal("principalAddressCity", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">State *</div>
              <input className="input" value={form.principalAddressState} onChange={(e) => setVal("principalAddressState", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">ZIP *</div>
              <input className="input" inputMode="numeric" value={form.principalAddressZip} onChange={(e) => setVal("principalAddressZip", digitsOnly(e.target.value).slice(0, 10))} />
            </div>
          </div>

          <div className="sectionHeading">ID + Contact</div>
          <div className="grid2">
            <div className="row">
              <div className="label">Driver's License # *</div>
              <input className="input" value={form.idNumber} onChange={(e) => setVal("idNumber", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">State Issued *</div>
              <input className="input" value={form.dlState} onChange={(e) => setVal("dlState", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Expiration *</div>
              <input className="input" type="date" value={form.idExp} onChange={(e) => setVal("idExp", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Owner Email *</div>
              <input className="input" value={form.contactEmail} onChange={(e) => setVal("contactEmail", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Cell Phone * (10 digits)</div>
              <input
                className="input"
                inputMode="numeric"
                value={form.contactPhone}
                onChange={(e) => setVal("contactPhone", digitsOnly(e.target.value).slice(0, 10))}
              />
            </div>
            <div className="row">
              <div className="label">Home Phone (10 digits)</div>
              <input
                className="input"
                inputMode="numeric"
                value={form.ownerHomePhone}
                onChange={(e) => setVal("ownerHomePhone", digitsOnly(e.target.value).slice(0, 10))}
              />
            </div>
          </div>

          <div className="sectionHeading">Banking Information</div>
          <div className="grid2">
            <div className="row">
              <div className="label">Bank Name *</div>
              <input className="input" value={form.bankName} onChange={(e) => setVal("bankName", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Routing Number *</div>
              <input className="input" inputMode="numeric" value={form.routingNumber} onChange={(e) => setVal("routingNumber", digitsOnly(e.target.value))} />
            </div>
            <div className="row">
              <div className="label">Account Number *</div>
              <input className="input" inputMode="numeric" value={form.accountNumber} onChange={(e) => setVal("accountNumber", digitsOnly(e.target.value))} />
            </div>
          </div>

          <div className="btnRow">
            <button className="btn btnGhost" onClick={back}>Back</button>
            <button className="btn btnPrimary" onClick={next}>Next</button>
          </div>
        </div>
      )}

      {step === "additional" && (
        <div className="card">
          <div className="cardTitle">4) Additional + Signature</div>

          <div className="grid2">
            <div className="row">
              <div className="label">Terminal *</div>
              <input className="input" value={form.ccTerminal} onChange={(e) => setVal("ccTerminal", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Encryption *</div>
              <select className="select" value={form.encryption} onChange={(e) => setVal("encryption", e.target.value)}>
                <option value="">Select…</option>
                <option value="wf350">WF 350 - Nashville</option>
                <option value="wf351">WF 351 - Buypass </option>
                <option value="other">Other </option>
                <option value="na">N/A </option>
              </select>
            </div>
            <div className="row">
              <div className="label">Gas Station POS *</div>
              <select className="select" value={form.gasStationPos} onChange={(e) => setVal("gasStationPos", e.target.value)}>
                <option value="">Select…</option>
                <option value="PetroTechPos">PetroTech POS</option>
                <option value="Ruby - Commander">Ruby - Commander </option>
                <option value="Ruby- w/Micronode">Ruby - w/Micronode </option>
                <option value="gilbarco">Gilbarco</option>
                <option value="na">N/A</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div className="row">
              <div className="label">PRICING *</div>
              <input className="input" inputMode="text" value={form.pricing} onChange={(e) => setVal("pricing", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Installation Date *</div>
              <input className="input" type="date" value={form.installationDate} onChange={(e) => setVal("installationDate", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Other Fleet Cards *</div>
              <input className="input" type="text" value={form.otherfleetcards} onChange={(e) => setVal("otherfleetcards", e.target.value)} />
            </div>
          </div>

          <div className="row">
            <div className="label">Other Notes</div>
            <textarea className="textarea" value={form.otherNotes} onChange={(e) => setVal("otherNotes", e.target.value)} />
          </div>

          <div className="sectionHeading">Signature & Terms</div>

          <div className="row">
            <div className="label">Signature (required)</div>
            <div className="sigBox">
              <SignatureCanvas
                ref={sigRef}
                penColor="black"
                backgroundColor="white"
                canvasProps={{
                  style: {
                    width: "100%",
                    height: "220px",
                    borderRadius: "12px"
                  }
                }}
              />
            </div>
            <div className="btnRow" style={{ marginTop: 8 }}>
              <button className="btn btnGhost" type="button" onClick={() => sigRef.current?.clear()}>
                Clear Signature
              </button>
            </div>
          </div>

          <div className="grid2">
            <div className="row">
              <div className="label">Signer Name *</div>
              <input className="input" value={form.signatureName} onChange={(e) => setVal("signatureName", e.target.value)} />
            </div>
            <div className="row">
              <div className="label">Signature Date *</div>
              <input className="input" type="date" value={form.signatureDate} onChange={(e) => setVal("signatureDate", e.target.value)} />
            </div>
          </div>

          <div className="row">
            <label className="notice checkboxLine">
              <input type="checkbox" checked={form.termsAccepted} onChange={(e) => setVal("termsAccepted", e.target.checked)} /> By submitting, you agree to all Terms & Conditions *
            </label>
          </div>

          <div className="btnRow">
            <button className="btn btnGhost" onClick={back}>Back</button>
            <button className="btn btnPrimary" disabled={busy} onClick={handleSubmit}>
              {busy ? "Submitting…" : "Submit"}
            </button>
          </div>

          {!!status && <div className="notice" style={{ marginTop: 10 }}>{status}</div>}
        </div>
      )}
    </div>
  );
}
